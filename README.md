# VPS Initial Setup Script

Автоматический скрипт для первоначальной настройки VPS сервера согласно best practices безопасности и производительности.

## Поддерживаемые дистрибутивы

- Ubuntu (все версии)
- Debian (все версии)
- CentOS / RHEL
- Fedora

## Что делает скрипт

### 1. Обновление системы
- Обновляет список пакетов
- Устанавливает все доступные обновления безопасности
- Удаляет неиспользуемые пакеты

### 2. Установка базовых утилит
- curl, wget, git
- vim, nano (редакторы)
- htop (мониторинг)
- ufw/firewalld (firewall)
- fail2ban (защита от брутфорса)
- и другие полезные инструменты

### 3. Создание нового пользователя
- Создает нового пользователя с sudo правами
- Настраивает домашнюю директорию
- Подготавливает директорию для SSH ключей

### 4. Настройка SSH безопасности
- Отключает вход под root
- Опционально отключает парольную аутентификацию (только ключи)
- Опционально изменяет SSH порт
- Ограничивает количество попыток входа
- Настраивает таймауты соединения
- Отключает X11 forwarding

### 5. Настройка Firewall
- Настраивает UFW (Ubuntu/Debian) или Firewalld (CentOS/RHEL/Fedora)
- Разрешает только необходимые порты
- Блокирует все входящие соединения по умолчанию

### 6. Настройка Fail2ban
- Защита от брутфорс атак
- Автоматическая блокировка подозрительных IP
- Настраиваемые параметры бана

### 7. Автоматические обновления безопасности
- Настраивает автоматическую установку обновлений безопасности
- Настраивает периодическую очистку системы

### 8. Настройка Timezone
- Устанавливает правильный часовой пояс

### 9. Настройка Swap
- Опционально создает swap файл
- Оптимизирует параметры swappiness

### 10. Оптимизация sysctl
- Настройки безопасности сети
- Оптимизация производительности TCP/IP
- Защита от различных сетевых атак

### 11. Настройка лимитов системы
- Увеличение лимитов файловых дескрипторов
- Увеличение лимитов процессов

### 12. Отключение ненужных служб
- Отключает неиспользуемые службы (bluetooth, cups, avahi-daemon)

## Использование

### Шаг 1: Загрузка скрипта на сервер

```bash
# Скачайте скрипт на ваш VPS сервер
wget https://your-server.com/vps-initial-setup.sh
# или
scp vps-initial-setup.sh user@your-server:/tmp/
```

### Шаг 2: Запуск скрипта

```bash
# Сделайте скрипт исполняемым
chmod +x vps-initial-setup.sh

# Запустите с правами root
sudo bash vps-initial-setup.sh
```

### Шаг 3: Следование инструкциям

Скрипт интерактивный и будет запрашивать:
- Имя нового пользователя
- Пароль для нового пользователя
- Отключить ли парольную аутентификацию SSH
- Изменить ли SSH порт
- Разрешить ли HTTP/HTTPS порты
- Создать ли swap файл
- И другие параметры

## Важные предупреждения

⚠️ **КРИТИЧЕСКИ ВАЖНО:**

1. **Перед отключением парольной аутентификации SSH:**
   - Убедитесь, что у вас есть SSH ключ
   - Добавьте публичный ключ в `~/.ssh/authorized_keys` нового пользователя
   - Протестируйте вход по ключу перед отключением паролей

2. **Перед изменением SSH порта:**
   - Убедитесь, что новый порт открыт в firewall провайдера
   - Не закрывайте текущую SSH сессию до проверки нового порта
   - Откройте новую сессию в отдельном терминале для проверки

3. **Резервные копии:**
   - Скрипт создает резервные копии конфигураций
   - Но рекомендуется сделать полный бэкап сервера перед запуском

4. **Проверка firewall:**
   - Убедитесь, что необходимые порты открыты
   - Проверьте доступность сервисов после настройки

## После выполнения скрипта

1. **Добавьте SSH ключ для нового пользователя:**
   ```bash
   # На вашем локальном компьютере
   ssh-copy-id -p PORT newuser@your-server-ip
   
   # Или вручную
   cat ~/.ssh/id_rsa.pub | ssh newuser@your-server-ip "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"
   ```

2. **Войдите под новым пользователем и проверьте:**
   ```bash
   ssh -p PORT newuser@your-server-ip
   sudo -v  # Проверка sudo прав
   ```

3. **Проверьте статус служб:**
   ```bash
   sudo systemctl status fail2ban
   sudo ufw status  # для Ubuntu/Debian
   sudo firewall-cmd --list-all  # для CentOS/RHEL/Fedora
   ```

4. **Проверьте логи:**
   ```bash
   sudo fail2ban-client status sshd
   sudo journalctl -u sshd -f
   ```

## Откат изменений

Если что-то пошло не так, вы можете откатить изменения:

1. **SSH конфигурация:**
   ```bash
   # Восстановить из резервной копии
   sudo cp /etc/ssh/sshd_config.backup.* /etc/ssh/sshd_config
   sudo systemctl restart sshd
   ```

2. **Firewall:**
   ```bash
   # Ubuntu/Debian
   sudo ufw disable
   
   # CentOS/RHEL/Fedora
   sudo systemctl stop firewalld
   sudo systemctl disable firewalld
   ```

## Дополнительные рекомендации

### Настройка мониторинга

После настройки рекомендуется установить:
- **Monitoring:** Prometheus, Grafana, или CloudWatch
- **Log aggregation:** ELK Stack или Loki
- **Backup:** автоматические бэкапы важных данных

### Дополнительная безопасность

1. **Настройка 2FA для SSH** (опционально)
2. **Установка и настройка AIDE** (интегрированная система обнаружения вторжений)
3. **Настройка автоматических бэкапов**
4. **Регулярный аудит безопасности**

### Производительность

1. **Настройка swap** (если не сделано скриптом)
2. **Оптимизация параметров ядра** (если требуется)
3. **Настройка кэширования** (если используется)

## Поддержка

Если у вас возникли проблемы:
1. Проверьте логи: `sudo journalctl -xe`
2. Проверьте статус служб: `sudo systemctl status SERVICE_NAME`
3. Убедитесь, что все порты открыты в firewall провайдера

## Лицензия

Этот скрипт предоставляется "как есть" без каких-либо гарантий. Используйте на свой риск.

## Автор

Скрипт создан для автоматизации первоначальной настройки VPS серверов согласно best practices безопасности и производительности.

